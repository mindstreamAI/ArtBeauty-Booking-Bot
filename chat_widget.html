<!-- Universal Booking Chat Widget -->
<!-- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –≤–∏–¥–∂–µ—Ç —á–∞—Ç–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ -->
<style>
#booking-chat-btn {
  position: fixed;
  bottom: 32px;
  right: 32px;
  z-index: 9999;
  background: #6366f1;
  color: #fff;
  border: none;
  border-radius: 50%;
  width: 64px;
  height: 64px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.15);
  font-size: 32px;
  cursor: pointer;
  transition: background 0.2s;
}
#booking-chat-btn:hover { background: #4f46e5; }

#booking-chat-window {
  display: none;
  position: fixed;
  bottom: 110px;
  right: 32px;
  width: 340px;
  max-width: 95vw;
  height: 420px;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.18);
  z-index: 10000;
  flex-direction: column;
  overflow: hidden;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
}

#booking-chat-header {
  background: #6366f1;
  color: #fff;
  padding: 16px;
  font-size: 18px;
  font-weight: bold;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

#booking-chat-close {
  background: none;
  border: none;
  color: #fff;
  font-size: 22px;
  cursor: pointer;
  opacity: 0.9;
  transition: opacity 0.2s;
}
#booking-chat-close:hover { opacity: 1; }

#booking-chat-messages {
  flex: 1;
  padding: 12px;
  overflow-y: auto;
  background: #f9fafb;
}

.booking-msg {
  margin-bottom: 10px;
  display: flex;
}
.booking-msg-user { justify-content: flex-end; }
.booking-msg-bot { justify-content: flex-start; }

.booking-bubble {
  max-width: 80%;
  padding: 10px 14px;
  border-radius: 16px;
  font-size: 15px;
  line-height: 1.4;
  word-wrap: break-word;
}
.booking-bubble-user {
  background: #6366f1;
  color: #fff;
  border-bottom-right-radius: 4px;
}
.booking-bubble-bot {
  background: #fff;
  color: #333;
  border-bottom-left-radius: 4px;
  border: 1px solid #e5e7eb;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

#booking-chat-form {
  display: flex;
  border-top: 1px solid #e5e7eb;
  background: #fff;
}

#booking-chat-input {
  flex: 1;
  border: none;
  padding: 12px;
  font-size: 15px;
  outline: none;
}

#booking-chat-send {
  background: #6366f1;
  color: #fff;
  border: none;
  padding: 0 18px;
  font-size: 18px;
  cursor: pointer;
  transition: background 0.2s;
}
#booking-chat-send:hover { background: #4f46e5; }
#booking-chat-send:disabled { 
  background: #9ca3af; 
  cursor: not-allowed; 
}
</style>

<button id="booking-chat-btn" title="–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç"><span>üí¨</span></button>
<div id="booking-chat-window">
  <div id="booking-chat-header">
    –ß–∞—Ç —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º
    <button id="booking-chat-close" title="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
  </div>
  <div id="booking-chat-messages"></div>
  <form id="booking-chat-form">
    <input id="booking-chat-input" type="text" placeholder="–í–∞—à –≤–æ–ø—Ä–æ—Å..." autocomplete="off" required />
    <button id="booking-chat-send" type="submit">‚û§</button>
  </form>
</div>

<script>
// ============================================
// –ù–ê–°–¢–†–û–ô–ö–ê: –£–∫–∞–∂–∏—Ç–µ URL –≤–∞—à–µ–≥–æ backend
// ============================================
// –î–ª—è ngrok (–ª–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞):
// const BACKEND_URL = 'https://abc123.ngrok-free.app/widget';
// 
// –î–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä–∞:
// const BACKEND_URL = 'https://your-domain.com/widget';

const BACKEND_URL = 'https://YOUR-BACKEND-URL.ngrok-free.app/widget';

// ============================================
// –ö–æ–¥ –≤–∏–¥–∂–µ—Ç–∞ (–Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π)
// ============================================

const chatBtn = document.getElementById('booking-chat-btn');
const chatWindow = document.getElementById('booking-chat-window');
const chatClose = document.getElementById('booking-chat-close');
const chatForm = document.getElementById('booking-chat-form');
const chatInput = document.getElementById('booking-chat-input');
const chatMessages = document.getElementById('booking-chat-messages');
const chatSend = document.getElementById('booking-chat-send');

// –û—Ç–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞
chatBtn.onclick = () => {
  chatWindow.style.display = 'flex';
  chatBtn.style.display = 'none';
  chatInput.focus();
  
  // –ü–µ—Ä–≤–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏)
  if (chatMessages.children.length === 0) {
    sendMessage('');
  }
};

// –ó–∞–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞
chatClose.onclick = () => {
  chatWindow.style.display = 'none';
  chatBtn.style.display = 'block';
};

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
function addMessage(text, isUser) {
  if (!text || text.trim().length === 0) return;
  
  const msg = document.createElement('div');
  msg.className = 'booking-msg ' + (isUser ? 'booking-msg-user' : 'booking-msg-bot');
  
  const bubble = document.createElement('div');
  bubble.className = 'booking-bubble ' + (isUser ? 'booking-bubble-user' : 'booking-bubble-bot');
  bubble.textContent = text;
  
  msg.appendChild(bubble);
  chatMessages.appendChild(msg);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

// –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
function addLoadingIndicator() {
  const msg = document.createElement('div');
  msg.className = 'booking-msg booking-msg-bot';
  msg.id = 'loading-indicator';
  
  const bubble = document.createElement('div');
  bubble.className = 'booking-bubble booking-bubble-bot';
  bubble.innerHTML = '<span style="opacity: 0.6;">‚óè‚óè‚óè</span>';
  
  msg.appendChild(bubble);
  chatMessages.appendChild(msg);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

function removeLoadingIndicator() {
  const loader = document.getElementById('loading-indicator');
  if (loader) loader.remove();
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
async function sendMessage(text) {
  try {
    chatSend.disabled = true;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    addLoadingIndicator();
    
    const res = await fetch(BACKEND_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ message: text })
    });
    
    if (!res.ok) throw new Error('Network error');
    
    const data = await res.json();
    
    // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
    removeLoadingIndicator();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –±–æ—Ç–∞
    const answer = data.answer ? data.answer.trim() : '';
    if (answer) {
      // –£–¥–∞–ª—è–µ–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞ (–µ—Å–ª–∏ –æ–Ω —Å–ª—É—á–∞–π–Ω–æ –ø–æ–ø–∞–ª)
      const cleanAnswer = answer.replace(/\{[^}]*"–ò–º—è"[^}]*\}/g, '').trim();
      if (cleanAnswer) addMessage(cleanAnswer, false);
    }
    
    // –ï—Å–ª–∏ –∑–∞—è–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
    if (data.saved) {
      addMessage('‚úÖ –û—Ç–ª–∏—á–Ω–æ! –í–∞—à–∞ –∑–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞. –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.', false);
    }
    
  } catch (err) {
    removeLoadingIndicator();
    addMessage('‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É.', false);
    console.error('Chat error:', err);
  } finally {
    chatSend.disabled = false;
  }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
chatForm.onsubmit = async (e) => {
  e.preventDefault();
  const text = chatInput.value.trim();
  if (!text) return;
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  addMessage(text, true);
  chatInput.value = '';
  
  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
  await sendMessage(text);
};
</script>
<!-- /Universal Booking Chat Widget -->